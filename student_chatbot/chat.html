<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HostelBot</title>
  <style>
    .chat-floating-btn {
      position: fixed; right: 24px; bottom: 24px;
      background:#1f2937; color:white; border-radius:50%;
      width:60px; height:60px; display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25); font-size:24px;
    }
    .chat-window {
      position: fixed; right: 24px; bottom: 96px;
      width: 360px; max-height: 70vh; background: #fff;
      border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.15);
      display: none; flex-direction: column; overflow: hidden; font-family: Arial, sans-serif;
    }
    .chat-header { background: #111827; color: white; padding: 12px; font-weight:700; }
    .chat-body { padding: 12px; overflow-y: auto; flex: 1; background: #f8fafc; }
    .message { margin: 8px 0; display:flex; }
    .message.user { justify-content: flex-end; }
    .bubble {
      max-width:80%; padding:10px 12px; border-radius: 10px; line-height:1.3;
    }
    .bubble.user { background:#111827; color:white; border-bottom-right-radius:2px; }
    .bubble.bot { background:#e6eef8; color:#021028; border-bottom-left-radius:2px; }
    .chat-footer { padding: 8px; border-top:1px solid #e6edf3; display:flex; gap:8px; }
    .chat-footer input { flex:1; padding:10px; border-radius:8px; border:1px solid #d7e2ea; }
    .chat-footer button { padding:10px 12px; border-radius:8px; background:#0b5cff; color:white; border:none; cursor:pointer; }
    .tiny { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>

<div class="chat-floating-btn" id="openBtn">ðŸ’¬</div>

<div class="chat-window" id="chatWindow">
  <div class="chat-header">HostelBot <span class="tiny" style="float:right">AI Assistant</span></div>
  <div class="chat-body" id="chatBody"></div>
  <div class="chat-footer">
    <input id="userInput" placeholder="Ask about menu, rooms, rules..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const openBtn = document.getElementById('openBtn');
const chatWindow = document.getElementById('chatWindow');
const chatBody = document.getElementById('chatBody');
const sendBtn = document.getElementById('sendBtn');
const userInput = document.getElementById('userInput');

openBtn.onclick = () => {
  chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
  chatWindow.style.flexDirection = 'column';
};

function appendMessage(text, who='bot') {
  const msg = document.createElement('div');
  msg.className = 'message ' + (who === 'user' ? 'user' : 'bot');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');
  bubble.innerHTML = text;
  msg.appendChild(bubble);
  chatBody.appendChild(msg);
  chatBody.scrollTop = chatBody.scrollHeight;
}

async function sendMessage() {
  const text = userInput.value.trim();
  if (!text) return;

  appendMessage(text, 'user');
  userInput.value = '';
  appendMessage('typing...', 'bot');

  try {
    const res = await fetch('/Hostel/student_chatbot/chat_api.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message: text})
    });
    const data = await res.json();

    // remove typing bubble
    const last = chatBody.lastChild;
    if (last && last.querySelector('.bubble') && last.querySelector('.bubble').textContent === 'typing...') {
      chatBody.removeChild(last);
    }

    if (data && data.reply) {
      appendMessage(data.reply, 'bot');
    } else {
      appendMessage('Sorry, no reply from server.', 'bot');
    }
  } catch(err) {
    console.error(err);
    const last = chatBody.lastChild;
    if (last && last.querySelector('.bubble') && last.querySelector('.bubble').textContent === 'typing...') {
      chatBody.removeChild(last);
    }
    appendMessage('Network/server error.', 'bot');
  }
}

sendBtn.onclick = sendMessage;
userInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') sendMessage();
});

</script>

</body>
</html>
